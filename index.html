<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CoC Tracker</title>
  <meta name="description" content="Solarized Clash Analytics">
  <style>
    @font-face {
      font-family: 'Clash';
      src: url('fonts/Clash_Regular.otf') format('opentype');
      font-weight: 400;
      font-style: normal;
    }

    @font-face {
      font-family: 'Clash';
      src: url('fonts/Clash_Bold.otf') format('opentype');
      font-weight: 700;
      font-style: normal;
    }

    :root {
      /* Solarized Dark Palette */
      --base03: #002b36;
      /* Background */
      --base02: #073642;
      /* Card Background */
      --base01: #586e75;
      /* Secondary Text */
      --base00: #657b83;
      --base0: #839496;
      /* Primary Text */
      --base1: #93a1a1;
      /* Highlight Text */
      --base2: #eee8d5;
      --base3: #fdf6e3;

      --yellow: #b58900;
      --orange: #cb4b16;
      --red: #dc322f;
      --magenta: #d33682;
      --violet: #6c71c4;
      --blue: #268bd2;
      --cyan: #2aa198;
      --green: #859900;

      /* Theme Assignments */
      --bg-body: var(--base03);
      --bg-sidebar: #00212b;
      /* Slightly darker teal */
      --bg-card: var(--base02);
      --bg-card-hover: #09414f;
      --bg-input: #003847;

      --text-main: var(--base1);
      /* Mild Light Teal */
      --text-muted: var(--base01);
      /* Darker Teal Grey */
      --text-highlight: var(--base3);
      /* Cream */

      --border: #0b5163;
      --radius: 8px;

      --font-main: 'Clash', sans-serif;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: var(--font-main);
      background-color: var(--bg-body);
      color: var(--text-main);
      height: 100vh;
      display: flex;
      overflow: hidden;
      font-size: 14px;
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bg-body);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--base01);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--base00);
    }

    /* Mobile Filter Toggle */
    .hamburger {
      display: none;
      flex-direction: column;
      gap: 4px;
      background: none;
      border: none;
      cursor: pointer;
      padding: 8px;
    }

    .hamburger span {
      width: 24px;
      height: 2px;
      background: var(--text-main);
      transition: all 0.3s;
    }

    .filter-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 90;
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
      body {
        flex-direction: column;
        height: 100vh;
        overflow: hidden;
      }

      .sidebar {
        position: fixed;
        top: 0;
        left: 0;
        bottom: 0;
        width: 80%;
        max-width: 280px;
        z-index: 95;
        transform: translateX(-100%);
        box-shadow: 2px 0 8px rgba(0, 0, 0, 0.3);
      }

      .sidebar.open {
        transform: translateX(0);
      }

      .hamburger {
        display: flex;
      }

      .filter-overlay.show {
        display: block;
      }

      .main {
        width: 100%;
        height: 100vh;
        overflow: hidden;
      }

      .top-bar {
        flex-direction: row;
        gap: 8px;
        padding: 10px 12px;
        flex-wrap: wrap;
      }

      .top-left {
        flex: 1;
        min-width: 0;
        gap: 8px;
        flex-wrap: wrap;
      }

      .top-right {
        display: flex;
        gap: 8px;
        align-items: center;
      }

      .stat-pill {
        min-width: 0;
      }

      .stat-val {
        font-size: 14px;
      }

      .stat-lbl {
        font-size: 9px;
      }

      .sort-select,
      .sort-btn {
        font-size: 11px;
        padding: 4px 6px;
      }

      .grid-container {
        padding: 8px;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
      }

      .grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
      }

      .card-wrapper {
        height: 140px;
      }

      .face {
        padding: 8px;
      }

      .c-header {
        margin-bottom: 6px;
      }

      .c-name {
        font-size: 12px;
        max-width: 80px;
      }

      .c-tag {
        font-size: 9px;
      }

      .c-link {
        font-size: 8px;
        padding: 2px 4px;
      }

      .badges {
        gap: 2px;
        margin-bottom: 6px;
      }

      .badge {
        font-size: 8px;
        padding: 2px 4px;
      }

      .end-time-badge {
        font-size: 8px;
        gap: 2px;
      }

      .stats-row {
        gap: 4px;
        margin-bottom: 4px;
      }

      .stat {
        padding: 4px 2px;
      }

      .s-val {
        font-size: 11px;
      }

      .s-lbl {
        font-size: 7px;
      }

      .footer {
        margin-top: 6px;
        padding-top: 6px;
      }

      .raid-row {
        gap: 4px;
      }

      .raid-status {
        font-size: 8px;
        gap: 3px;
      }

      .raid-dot {
        width: 5px;
        height: 5px;
      }

      .raid-stats {
        gap: 6px;
      }

      .rs-val {
        font-size: 9px;
      }

      .rs-lbl {
        font-size: 6px;
      }

      /* Back face */
      .back-title {
        font-size: 9px;
        margin-bottom: 6px;
      }

      .th-container {
        gap: 3px;
      }

      .th-pill {
        font-size: 9px;
        padding: 2px 4px;
      }

      .vs-text {
        font-size: 9px;
        margin: 8px 0;
      }
    }

    /* Sidebar */
    .sidebar {
      width: 280px;
      background-color: var(--bg-sidebar);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      padding: 24px;
      overflow-y: auto;
      flex-shrink: 0;
      transition: transform 0.3s ease;
    }

    /* Tablet */
    @media (min-width: 769px) and (max-width: 1024px) {
      .sidebar {
        width: 240px;
        padding: 20px;
      }

      .grid {
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      }
    }

    .brand {
      font-size: 26px;
      font-weight: 700;
      color: var(--yellow);
      margin-bottom: 24px;
      text-transform: uppercase;
      letter-spacing: 1px;
      text-align: center;
    }

    .filter-group {
      margin-bottom: 20px;
    }

    .filter-label {
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      color: var(--blue);
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      letter-spacing: 0.5px;
    }

    .btn-mini {
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 10px;
      cursor: pointer;
      padding: 0;
      font-family: var(--font-main);
    }

    .btn-mini:hover {
      color: var(--text-main);
      text-decoration: underline;
    }

    .input-box {
      width: 100%;
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 8px 10px;
      color: var(--text-main);
      font-family: var(--font-main);
      font-size: 13px;
      transition: all 0.2s;
    }

    .input-box:focus {
      outline: none;
      border-color: var(--blue);
    }

    .toggle-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .toggle-btn {
      flex: 1;
      background: var(--bg-input);
      border: 1px solid var(--border);
      color: var(--text-muted);
      padding: 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      text-align: center;
      transition: all 0.2s;
      white-space: nowrap;
      text-transform: capitalize;
    }

    .toggle-btn:hover {
      border-color: var(--text-main);
      color: var(--text-main);
    }

    .toggle-btn.active {
      background: var(--bg-card);
      border-color: var(--yellow);
      color: var(--yellow);
      box-shadow: 0 0 0 1px var(--yellow);
    }

    .btn-clear {
      width: 100%;
      padding: 10px;
      background: transparent;
      border: 1px solid var(--red);
      color: var(--red);
      border-radius: 4px;
      font-weight: 700;
      cursor: pointer;
      margin-top: auto;
      font-family: var(--font-main);
      text-transform: uppercase;
      font-size: 12px;
      transition: all 0.2s;
    }

    .btn-clear:hover {
      background: var(--red);
      color: var(--base3);
    }

    /* Main Area */
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      position: relative;
    }

    .top-bar {
      padding: 16px 24px;
      background: var(--bg-body);
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 40;
    }

    .top-left {
      display: flex;
      gap: 24px;
      align-items: center;
    }

    .top-right {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .stat-pill {
      display: flex;
      flex-direction: column;
    }

    .stat-val {
      font-size: 20px;
      font-weight: 700;
      color: var(--text-highlight);
      line-height: 1;
    }

    .stat-lbl {
      font-size: 10px;
      color: var(--text-muted);
      text-transform: uppercase;
      margin-top: 2px;
    }

    .sort-select {
      background: var(--bg-input);
      border: 1px solid var(--border);
      color: var(--text-main);
      padding: 6px 10px;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
      font-family: var(--font-main);
    }

    .sort-btn {
      background: var(--bg-input);
      border: 1px solid var(--border);
      color: var(--text-main);
      padding: 6px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }

    /* Grid */
    .grid-container {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 16px;
    }

    /* Compact Card */
    .card-wrapper {
      perspective: 1000px;
      height: 200px;
    }

    .card {
      position: relative;
      width: 100%;
      height: 100%;
      transition: transform 0.4s;
      transform-style: preserve-3d;
      cursor: pointer;
    }

    .card-wrapper.flipped .card {
      transform: rotateY(180deg);
    }

    .face {
      position: absolute;
      width: 100%;
      height: 100%;
      backface-visibility: hidden;
      border-radius: var(--radius);
      background: var(--bg-card);
      border: 1px solid var(--border);
      padding: 16px;
      display: flex;
      flex-direction: column;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .face:hover {
      border-color: var(--base1);
      transform: translateY(-2px);
    }

    .face.back {
      transform: rotateY(180deg);
      background: #002129;
      justify-content: center;
      align-items: center;
    }

    /* Card Content */
    .c-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
    }

    .c-name {
      font-size: 16px;
      font-weight: 700;
      color: var(--text-highlight);
      margin-bottom: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 150px;
    }

    .c-tag {
      font-family: monospace;
      font-size: 11px;
      color: var(--text-muted);
    }

    .c-link {
      color: var(--blue);
      text-decoration: none;
      font-size: 10px;
      font-weight: 700;
      border: 1px solid var(--blue);
      padding: 3px 8px;
      border-radius: 4px;
      transition: all 0.2s;
      text-transform: uppercase;
    }

    .c-link:hover {
      background: var(--blue);
      color: var(--base3);
    }

    .badges {
      display: flex;
      gap: 4px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }

    .badge {
      font-size: 10px;
      font-weight: 700;
      padding: 3px 6px;
      border-radius: 4px;
      text-transform: uppercase;
      background: var(--bg-input);
      border: 1px solid var(--border);
      color: var(--text-muted);
    }

    /* Special Logic Colors */
    .bg-war-active {
      background: rgba(220, 50, 47, 0.2);
      color: var(--red);
      border-color: var(--red);
    }

    /* Red for War/Prep */
    .bg-war-peace {
      background: rgba(133, 153, 0, 0.2);
      color: var(--green);
      border-color: var(--green);
    }

    /* Green for Ended/Idle */

    .bg-lvl-high {
      color: var(--yellow);
      border-color: var(--yellow);
    }

    .stats-row {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin-bottom: auto;
    }

    .stat {
      background: var(--bg-input);
      padding: 6px;
      border-radius: 4px;
      text-align: center;
    }

    .s-val {
      font-size: 14px;
      font-weight: 700;
      color: var(--text-main);
    }

    .s-lbl {
      font-size: 9px;
      color: var(--text-muted);
      text-transform: uppercase;
      margin-top: 2px;
    }

    .val-high-streak {
      color: var(--cyan);
    }

    .footer {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .raid-row {
      display: flex;
      align-items: center;
      gap: 8px;
      width: 100%;
    }

    .raid-status {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      font-weight: 600;
      color: var(--text-muted);
    }

    .raid-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .rd-green {
      background: var(--green);
      box-shadow: 0 0 6px var(--green);
    }

    .rd-red {
      background: var(--red);
    }

    .rd-grey {
      background: var(--base01);
    }

    .raid-stats {
      margin-left: auto;
      display: flex;
      gap: 12px;
      text-align: right;
    }

    .rs-item {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
    }

    .rs-val {
      font-weight: 700;
      font-size: 12px;
      color: var(--text-main);
    }

    .rs-lbl {
      font-size: 8px;
      color: var(--text-muted);
      text-transform: uppercase;
    }

    .end-time-badge {
      font-weight: 700;
      color: var(--orange);
      font-size: 11px;
      display: flex;
      align-items: center;
      gap: 4px;
      margin-left: auto;
    }

    /* Back Face */
    .back-title {
      font-size: 11px;
      font-weight: 700;
      color: var(--blue);
      text-transform: uppercase;
      margin-bottom: 12px;
      letter-spacing: 1px;
    }

    .th-container {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      justify-content: center;
      max-width: 100%;
    }

    .th-pill {
      padding: 3px 6px;
      border-radius: 4px;
      font-weight: 700;
      font-size: 12px;
      background: var(--bg-input);
      border: 1px solid var(--border);
      color: var(--text-muted);
    }

    .th-18 {
      background: rgba(38, 139, 210, 0.2);
      border-color: var(--blue);
      color: var(--base3);
    }

    .vs-text {
      font-weight: 700;
      color: var(--red);
      margin: 12px 0;
      font-size: 12px;
    }

    .loader {
      grid-column: 1 / -1;
      text-align: center;
      padding: 40px;
      color: var(--text-muted);
      font-size: 16px;
    }
  </style>
</head>

<body>

  <aside class="sidebar">
    <div class="brand">CoC Tracker</div>

    <div class="filter-group">
      <div class="filter-label">Search</div>
      <input type="text" class="input-box" id="searchInput" placeholder="Name or Tag..." oninput="app.filter()">
    </div>

    <div class="filter-group">
      <div class="filter-label">
        War Status
        <button class="btn-mini" onclick="app.toggleAll('states')">All</button>
      </div>
      <div class="toggle-grid" id="statusFilters"></div>
    </div>

    <div class="filter-group">
      <div class="filter-label">
        Raid Status
        <button class="btn-mini" onclick="app.toggleAll('raidStates')">All</button>
      </div>
      <div class="toggle-grid" id="raidFilters"></div>
    </div>

    <div class="filter-group">
      <div class="filter-label">
        Clan Type
        <button class="btn-mini" onclick="app.toggleAll('types')">All</button>
      </div>
      <div class="toggle-grid" id="typeFilters"></div>
    </div>

    <div class="filter-group">
      <div class="filter-label">War Ended (Hours)</div>
      <input type="number" class="input-box" id="exactEndTime" placeholder="e.g. 0" oninput="app.filter()">
    </div>

    <div class="filter-group">
      <div class="filter-label">Min Thresholds</div>
      <div style="display:grid; gap:6px">
        <input type="number" class="input-box" id="minStreak" placeholder="Streak" oninput="app.filter()">
        <input type="number" class="input-box" id="minReward" placeholder="Raid Medals" oninput="app.filter()">
        <input type="number" class="input-box" id="minRaids" placeholder="Attacks" oninput="app.filter()">
      </div>
    </div>

    <button class="btn-clear" onclick="app.reset()">Reset Filters</button>
  </aside>

  <main class="main">
    <div class="top-bar">
      <button class="hamburger" onclick="app.toggleFilters()">
        <span></span>
        <span></span>
        <span></span>
      </button>

      <div class="top-left" id="topStats">
        <!-- Stats -->
      </div>

      <div class="top-right">
        <div class="stat-pill">
          <span class="stat-val" id="updatedTime" style="font-size:14px">--:--</span>
          <span class="stat-lbl">Updated</span>
        </div>
        <select class="sort-select" id="sortBy" onchange="app.sort()">
          <option value="clanPoints">Points</option>
          <option value="clanLevel">Level</option>
          <option value="members">Members</option>
          <option value="warWins">Wins</option>
          <option value="warWinStreak">Streak</option>
          <option value="raidTotalReward">Medals</option>
          <option value="raidsCompleted">Attacks</option>
          <option value="end_time">End Time</option>
        </select>
        <button class="sort-btn" onclick="app.toggleSort()" id="sortBtn">⬇</button>
      </div>
    </div>

    <div class="grid-container">
      <div class="grid" id="grid">
        <!-- Cards -->
      </div>
      <div id="loadTrigger" style="height:20px; margin-top:20px"></div>
    </div>
  </main>

  <!-- Mobile Filter Overlay -->
  <div class="filter-overlay" onclick="app.toggleFilters()"></div>

  <script src="data.js"></script>
  <script>
    const app = {
      data: [],
      filtered: [],
      displayLimit: 100,
      sortCol: 'clanPoints',
      sortAsc: false,

      filters: {
        search: '',
        states: new Set(),
        types: new Set(),
        raidStates: new Set(),
        exactEndTime: '',
        minStreak: '',
        minReward: '',
        minRaids: ''
      },

      async init() {
        try {
          // 1. Try fetching clans.json (Works on GitHub Pages / Web Server)
          const response = await fetch('clans.json');
          if (!response.ok) throw new Error('Network response was not ok');
          const json = await response.json();
          this.loadData(json);
        } catch (error) {
          // 2. Fallback to data.js (Works locally via file://)
          if (typeof CLANS_DATA !== 'undefined') {
            console.log('Falling back to local data.js');
            this.loadData(CLANS_DATA);
          } else {
            document.getElementById('grid').innerHTML = '<div class="loader">Error: Could not load clans.json.</div>';
            console.error('Data load failed:', error);
          }
        }
      },

      loadData(json) {
        this.data = json.clans;
        document.getElementById('updatedTime').textContent = json.updated;
        this.renderDynamicFilters();
        this.filter();
        this.setupScroll();
      },

      toggleFilters() {
        const sidebar = document.querySelector('.sidebar');
        const overlay = document.querySelector('.filter-overlay');
        sidebar.classList.toggle('open');
        overlay.classList.toggle('show');
      },

      renderDynamicFilters() {
        const uniqueStates = [...new Set(this.data.map(c => c.state || 'Idle'))].sort();
        const uniqueRaidStates = [...new Set(this.data.map(c => c.raidState || 'Unknown'))].sort();
        const uniqueTypes = [...new Set(this.data.map(c => c.type))].sort();

        this.renderToggles('statusFilters', uniqueStates, 'states');
        this.renderToggles('raidFilters', uniqueRaidStates, 'raidStates');
        this.renderToggles('typeFilters', uniqueTypes, 'types');
      },

      renderToggles(id, items, key) {
        document.getElementById(id).innerHTML = items.map(val => `
          <button class="toggle-btn" onclick="app.toggle('${key}', '${val}', this)">
            ${val.replace(/([A-Z])/g, ' $1').trim()}
          </button>
        `).join('');
      },

      toggle(key, val, btn) {
        if (this.filters[key].has(val)) {
          this.filters[key].delete(val);
          btn.classList.remove('active');
        } else {
          this.filters[key].add(val);
          btn.classList.add('active');
        }
        this.filter();
      },

      toggleAll(key) {
        const container = document.getElementById(key === 'states' ? 'statusFilters' : key === 'raidStates' ? 'raidFilters' : 'typeFilters');
        const btns = Array.from(container.children);
        const allActive = btns.every(b => b.classList.contains('active'));
        btns.forEach(b => {
          if (allActive) { if (b.classList.contains('active')) b.click(); }
          else { if (!b.classList.contains('active')) b.click(); }
        });
      },

      reset() {
        this.filters.search = '';
        this.filters.states.clear();
        this.filters.types.clear();
        this.filters.raidStates.clear();
        this.filters.exactEndTime = '';
        this.filters.minStreak = '';
        this.filters.minReward = '';
        this.filters.minRaids = '';

        document.getElementById('searchInput').value = '';
        document.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('input[type="number"]').forEach(i => i.value = '');

        this.filter();
      },

      filter() {
        this.filters.search = document.getElementById('searchInput').value.toLowerCase();
        this.filters.exactEndTime = document.getElementById('exactEndTime').value;
        this.filters.minStreak = document.getElementById('minStreak').value;
        this.filters.minReward = document.getElementById('minReward').value;
        this.filters.minRaids = document.getElementById('minRaids').value;

        this.filtered = this.data.filter(c => {
          if (this.filters.search && !c.name.toLowerCase().includes(this.filters.search) && !c.tag.toLowerCase().includes(this.filters.search)) return false;

          const cState = c.state || 'Idle';
          if (this.filters.states.size && !this.filters.states.has(cState)) return false;

          if (this.filters.types.size && !this.filters.types.has(c.type)) return false;

          const cRaid = c.raidState || 'Unknown';
          if (this.filters.raidStates.size && !this.filters.raidStates.has(cRaid)) return false;

          if (this.filters.exactEndTime !== '' && c.end_time != this.filters.exactEndTime) return false;
          if (this.filters.minStreak !== '' && c.warWinStreak < parseInt(this.filters.minStreak)) return false;
          if (this.filters.minReward !== '' && c.raidTotalReward < parseInt(this.filters.minReward)) return false;
          if (this.filters.minRaids !== '' && c.raidsCompleted < parseInt(this.filters.minRaids)) return false;

          return true;
        });

        this.sort();
      },

      sort() {
        this.sortCol = document.getElementById('sortBy').value;

        this.filtered.sort((a, b) => {
          let vA = a[this.sortCol];
          let vB = b[this.sortCol];

          if (vA == null) return 1;
          if (vB == null) return -1;

          if (vA < vB) return this.sortAsc ? -1 : 1;
          if (vA > vB) return this.sortAsc ? 1 : -1;
          return 0;
        });

        this.displayLimit = 100;
        this.render();
      },

      toggleSort() {
        this.sortAsc = !this.sortAsc;
        document.getElementById('sortBtn').textContent = this.sortAsc ? '⬆' : '⬇';
        this.sort();
      },

      render() {
        // Stats
        const total = this.filtered.length;
        const inWar = this.filtered.filter(c => c.state === 'inWar').length;
        const avgStreak = total ? Math.round(this.filtered.reduce((a, c) => a + c.warWinStreak, 0) / total) : 0;

        document.getElementById('topStats').innerHTML = `
          <div class="stat-pill"><span class="stat-val">${total.toLocaleString()}</span><span class="stat-lbl">Clans</span></div>
          <div class="stat-pill"><span class="stat-val">${inWar.toLocaleString()}</span><span class="stat-lbl">Active</span></div>
          <div class="stat-pill"><span class="stat-val">${avgStreak}</span><span class="stat-lbl">Avg Streak</span></div>
        `;

        // Grid
        const grid = document.getElementById('grid');
        grid.innerHTML = ''; // Clear existing

        const toShow = this.filtered.slice(0, this.displayLimit);

        if (toShow.length === 0) {
          grid.innerHTML = '<div class="loader">No results found.</div>';
          return;
        }

        grid.innerHTML = toShow.map(c => this.cardHTML(c)).join('');
      },

      appendItems() {
        const grid = document.getElementById('grid');
        const start = this.displayLimit - 50;
        const end = this.displayLimit;
        const nextBatch = this.filtered.slice(start, end);

        if (nextBatch.length > 0) {
          const html = nextBatch.map(c => this.cardHTML(c)).join('');
          grid.insertAdjacentHTML('beforeend', html);
        }
      },

      setupScroll() {
        const trigger = document.getElementById('loadTrigger');
        const container = document.querySelector('.grid-container');

        const options = {
          root: container,
          rootMargin: '400px', // Pre-load well before bottom
          threshold: 0
        };

        const observer = new IntersectionObserver(entries => {
          if (entries[0].isIntersecting && this.displayLimit < this.filtered.length) {
            this.displayLimit += 50;
            this.appendItems();
          }
        }, options);

        observer.observe(trigger);
      },

      cardHTML(c) {
        const link = `https://link.clashofclans.com/en?action=OpenClanProfile&tag=${c.tag.replace('#', '%23')}`;

        // Raid Status Logic
        let raidDotClass = 'rd-grey';
        if (c.raidState === 'ongoing') raidDotClass = 'rd-green';
        else if (c.raidState === 'ended') raidDotClass = 'rd-red';

        // War Status Logic
        let warBadgeClass = 'bg-war-peace'; // Default Green (Peace)
        let warBadgeText = c.state || 'IDLE';
        if (c.state === 'inWar' || c.state === 'preparation') {
          warBadgeClass = 'bg-war-active'; // Red (War)
        }

        // Level Logic
        let lvlClass = '';
        if (c.clanLevel > 20) lvlClass = 'bg-lvl-high';

        // Streak Logic
        let streakClass = '';
        if (c.warWinStreak > 10) streakClass = 'val-high-streak';

        return `
          <div class="card-wrapper" onclick="this.classList.toggle('flipped')">
            <div class="card">
              <div class="face">
                <div class="c-header">
                  <div>
                    <div class="c-name">${c.name}</div>
                    <div class="c-tag">${c.tag}</div>
                  </div>
                  <a href="${link}" class="c-link" target="_blank" onclick="event.stopPropagation()">OPEN ↗</a>
                </div>

                <div class="badges">
                  <span class="badge ${warBadgeClass}">${warBadgeText}</span>
                  <span class="badge ${lvlClass}">LVL ${c.clanLevel}</span>
                  <span class="badge">${c.warLeague.replace(' League', '')}</span>
                  ${c.end_time != null ? `<span class="end-time-badge">⏱ ${c.end_time}h</span>` : ''}
                </div>

                <div class="stats-row">
                  <div class="stat"><div class="s-val">${c.members}</div><div class="s-lbl">MEMBERS</div></div>
                  <div class="stat"><div class="s-val">${c.warWins}</div><div class="s-lbl">WINS</div></div>
                  <div class="stat"><div class="s-val ${streakClass}">${c.warWinStreak}</div><div class="s-lbl">STREAK</div></div>
                </div>

                <div class="footer">
                  <div class="raid-row">
                    <div class="raid-status">
                      <div class="raid-dot ${raidDotClass}"></div>
                      <span>${c.raidState || 'Unknown'}</span>
                    </div>
                    <div class="raid-stats">
                      <div class="rs-item"><span class="rs-val">${c.raidTotalReward || 0}</span><span class="rs-lbl">Medals</span></div>
                      <div class="rs-item"><span class="rs-val" style="color:var(--text-muted)">${c.raidsCompleted || 0}</span><span class="rs-lbl">Attacks</span></div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="face back">
                <div style="text-align:center">
                  <div class="back-title">TH COMPOSITION</div>
                  <div class="th-container">
                    ${this.formatTH(c.th_comp)}
                  </div>
                  
                  ${c.opp_th_comp ? `
                    <div class="vs-text">VS</div>
                    <div class="th-container">
                      ${this.formatTH(c.opp_th_comp)}
                    </div>
                  ` : ''}
                  
                  <div class="back-title" style="margin-top:16px; color:var(--text-muted)">WAR SIZE: ${c.teamSize || '?'}</div>
                </div>
              </div>
            </div>
          </div>
        `;
      },

      formatTH(comp) {
        if (!comp) return '<span class="s-lbl">No Data</span>';
        return comp.split(' ').map(p => {
          const [th, count] = p.split(':');
          const is18 = th === '18';
          return `<div class="th-pill ${is18 ? 'th-18' : ''}">${th}:${count}</div>`;
        }).join('');
      }
    };

    app.init();
  </script>
</body>

</html>